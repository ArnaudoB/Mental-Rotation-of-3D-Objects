<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Mental Rotation (Shepard–Metzler style) — Full 3D Replica</title>
  <style>
    :root{
      --bg:#0b0d10; --panel:#121720; --ink:#e8eefc; --muted:#9fb0d0; --accent:#6aa3ff; --ok:#53d17a; --bad:#ff6a6a;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Helvetica,Arial,sans-serif;background:var(--bg);color:var(--ink);}
    header{padding:16px 20px;border-bottom:1px solid #1c2330;background:linear-gradient(180deg,#0b0d10,#0b0d10 60%,#0e131b);} 
    h1{margin:4px 0 0;font-size:20px;letter-spacing:.2px}
    .wrap{max-width:1100px;margin:0 auto;padding:20px;}
    .grid{display:grid;gap:16px;grid-template-columns:1fr;}
    @media (min-width: 980px){.grid{grid-template-columns: 320px 1fr;}}
    .card{background:var(--panel);border:1px solid #1a2230;border-radius:16px;padding:16px;}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    label{font-size:14px;color:var(--muted)}
    input,select,button{background:#0e1420;color:var(--ink);border:1px solid #1a2230;border-radius:10px;padding:10px 12px;font-size:14px}
    input:disabled,select:disabled,button:disabled{opacity:.6}
    button.primary{background:var(--accent);border-color:#2a62ff;color:white;font-weight:600}
    button.good{background:var(--ok);border-color:#1f9c49;color:#04150b}
    button.bad{background:#2c1414;border-color:#552626;color:#ffbdbd}
    .muted{color:var(--muted);font-size:13px}
    .pill{display:inline-block;padding:4px 8px;border-radius:999px;border:1px solid #263147;background:#0f1520;color:var(--muted);font-size:12px}
    canvas.stage{width:100%;aspect-ratio:3/2;background:#0b0f18;border:1px solid #1a2230;border-radius:12px;display:block}
    .stage-wrap{display:grid;grid-template-columns:1fr 1fr;gap:14px}
    .kbd{font-family:ui-monospace, SFMono-Regular, Menlo, monospace;background:#0b0f18;border:1px solid #1a2230;padding:2px 6px;border-radius:6px}
    table{width:100%;border-collapse:collapse;font-size:14px}
    th,td{border-bottom:1px solid #1a2230;padding:8px 6px;text-align:right}
    th:nth-child(1),td:nth-child(1){text-align:left}
    .ok{color:var(--ok)}
    .err{color:var(--bad)}
    footer{opacity:.8;font-size:12px;text-align:center;padding:20px}
    .sep{height:1px;background:#1a2230;margin:6px 0 12px}
  </style>
</head>
<body>
  <header>
    <div class="wrap row" style="justify-content:space-between">
      <div>
        <div class="pill">3D replica</div>
        <h1>Mental Rotation Task — Shepard & Metzler (Interactive)</h1>
      </div>
      <div class="muted">Keys: <span class="kbd">S</span> = "Same", <span class="kbd">D</span> = "Different"</div>
    </div>
  </header>

  <div class="wrap grid">
    <section class="card">
      <h3 style="margin:6px 0 12px">Experiment setup</h3>
      <div class="row" style="margin-bottom:10px">
        <label for="pid">Participant ID</label>
        <input id="pid" placeholder="e.g., X21-001" />
      </div>
      <div class="row" style="margin-bottom:10px">
        <label for="ntrials">Trials</label>
        <input id="ntrials" type="number" min="10" value="80" style="width:100px"/>
        <label for="anglesel">Angles (deg)</label>
        <select id="anglesel" multiple size="6" style="min-width:160px">
          <option>0</option><option>20</option><option>40</option><option>60</option><option>80</option>
          <option>100</option><option>120</option><option>140</option><option>160</option><option>180</option>
        </select>
      </div>
      <div class="row" style="margin-bottom:10px">
        <label>Conditions</label>
        <label class="row"><input id="cond-same" type="checkbox" checked/> Same (rotation)</label>
        <label class="row"><input id="cond-diff" type="checkbox" checked/> Different (mirror)</label>
      </div>
      <div class="row" style="gap:8px">
        <button id="btn-shape">Regenerate base shape</button>
        <button id="btn-practice">Practice: 6 trials</button>
        <button id="btn-start" class="primary">Start experiment</button>
      </div>
      <div class="sep"></div>
      <div class="muted" id="status">Ready. Generate a base shape or start directly.</div>
    </section>

    <section class="card">
      <div class="stage-wrap">
        <canvas id="canvasL" class="stage" width="600" height="400"></canvas>
        <canvas id="canvasR" class="stage" width="600" height="400"></canvas>
      </div>
      <div class="row" style="margin-top:12px; gap:8px">
        <button id="btn-same" class="good">Same (S)</button>
        <button id="btn-diff" class="bad">Different (D)</button>
        <div class="pill" id="trialpill">Trial: –</div>
        <div class="pill" id="anglepill">Angle: –</div>
        <div class="pill" id="condpill">Condition: –</div>
        <div class="muted" id="feedback"></div>
      </div>
    </section>

    <section class="card" style="grid-column:1 / -1">
      <h3 style="margin:6px 0 12px">Results</h3>
      <div id="summary" class="muted">Run some trials to see per-angle reaction times and regression.</div>
      <div id="tables"></div>
      <div class="row" style="margin-top:10px; gap:8px">
        <button id="btn-export">Export CSV</button>
        <a id="dl" class="pill" href="#" download style="display:none">Download CSV</a>
      </div>
    </section>
  </div>

  <footer>Built with plain HTML/JS/CSS. Adds pseudo-3D perspective and full experimental logic (RT, regression, CSV export).</footer>

<script>
function randChoice(a){return a[Math.floor(Math.random()*a.length)]}
function shuffle(a){for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[a[i],a[j]]=[a[j],a[i]]}return a}
function genPolyomino(n=10){const dirs=[[1,0],[-1,0],[0,1],[0,-1]];let path=[{x:0,y:0}],cells=new Set(['0,0']);while(path.length<n){const [dx,dy]=randChoice(dirs);let nx=path.at(-1).x+dx,ny=path.at(-1).y+dy;const k=`${nx},${ny}`;if(!cells.has(k)){cells.add(k);path.push({x:nx,y:ny})}}const minx=Math.min(...path.map(p=>p.x)),miny=Math.min(...path.map(p=>p.y));return path.map(p=>({x:p.x-minx,y:p.y-miny}))}
function mirrorX(p){const maxx=Math.max(...p.map(c=>c.x));return p.map(c=>({x:maxx-c.x,y:c.y}))}
function project3D(x,y,z,angleX,angleY,scale){let rx=x,ry=y,rz=z;const radX=angleX*Math.PI/180,radY=angleY*Math.PI/180;const cx=Math.cos(radX),sx=Math.sin(radX),cy=Math.cos(radY),sy=Math.sin(radY);let y2=ry*cx-rz*sx,z2=ry*sx+rz*cx;let x2=rx*cy+z2*sy,z3=-rx*sy+z2*cy;return{x:x2*scale,y:y2*scale,z:z3*scale}}
function draw3D(ctx,poly,{angle=0,offsetX,offsetY}){ctx.save();ctx.translate(offsetX,offsetY);const scale=25;const depth=poly.map(p=>({...p,z:Math.random()*0.6-0.3}));const pts=depth.map(p=>project3D(p.x-2.5,p.y-2.5,p.z,30,angle,scale));ctx.beginPath();ctx.fillStyle='rgba(106,163,255,0.15)';ctx.strokeStyle='#7eb4ff';for(const pt of pts){ctx.rect(pt.x,pt.y,scale,scale)}ctx.fill();ctx.stroke();ctx.restore()}
function center(canvas){return{offsetX:canvas.width/2,offsetY:canvas.height/2}}

const ANGLE_DEFAULTS=[0,20,40,60,80,100,120,140,160,180];
let BASE=genPolyomino(10),MIRROR=mirrorX(BASE);
const canvasL=document.getElementById('canvasL'),canvasR=document.getElementById('canvasR');
const ctxL=canvasL.getContext('2d'),ctxR=canvasR.getContext('2d');
const state={trial:0,total:0,angles:[...ANGLE_DEFAULTS],allowSame:true,allowDiff:true,data:[],rtStart:null,angle:0,condition:null};
function clear(){ctxL.clearRect(0,0,canvasL.width,canvasL.height);ctxR.clearRect(0,0,canvasR.width,canvasR.height)}
function newTrial(){if(state.trial>=state.total)return finish();state.trial++;const angle=randChoice(state.angles);const cond=(Math.random()<0.5?'same':'diff');state.condition=cond;state.angle=angle;clear();draw3D(ctxL,BASE,{angle:0,...center(canvasL)});draw3D(ctxR,cond==='same'?BASE:MIRROR,{angle,...center(canvasR)});state.rtStart=performance.now();document.getElementById('trialpill').textContent=`Trial: ${state.trial}/${state.total}`;document.getElementById('anglepill').textContent=`Angle: ${angle}°`;document.getElementById('condpill').textContent=`Condition: ${cond}`;document.getElementById('feedback').textContent='';}
function respond(ans){if(!state.rtStart)return;const rt=performance.now()-state.rtStart;const correct=(ans===state.condition);state.data.push({trial:state.trial,angle:state.angle,cond:state.condition,ans,correct,rt});document.getElementById('feedback').innerHTML=correct?`<span class='ok'>Correct</span> (${Math.round(rt)} ms)`: `<span class='err'>Wrong</span> (${Math.round(rt)} ms)`;state.rtStart=null;setTimeout(newTrial,400)}
function finish(){document.getElementById('status').textContent=`Finished ${state.data.length} trials.`;summarize()}
function mean(a){return a.reduce((s,x)=>s+x,0)/a.length}
function sd(a){const m=mean(a);return Math.sqrt(mean(a.map(x=>(x-m)**2)))}
function linreg(x,y){const mx=mean(x),my=mean(y);let num=0,den=0,sst=0;for(let i=0;i<x.length;i++){const dx=x[i]-mx,dy=y[i]-my;num+=dx*dy;den+=dx*dx;sst+=(y[i]-my)**2;}const b=num/den,a=my-b*mx;let ssr=0;for(let i=0;i<x.length;i++){const yhat=a+b*x[i];ssr+=(yhat-my)**2;}return{a,b,r2:ssr/sst}}
function summarize(){const d=state.data.filter(e=>e.cond==='same'&&e.correct);if(!d.length)return;const byAngle={};d.forEach(e=>{(byAngle[e.angle]=byAngle[e.angle]||[]).push(e.rt)});const rows=Object.entries(byAngle).map(([a,v])=>({angle:+a,mean:mean(v),sd:sd(v),n:v.length})).sort((a,b)=>a.angle-b.angle);const xs=rows.map(r=>r.angle),ys=rows.map(r=>r.mean);const {a,b,r2}=linreg(xs,ys);document.getElementById('summary').textContent=`a=${a.toFixed(1)}ms, b=${b.toFixed(2)}ms/deg, R²=${r2.toFixed(3)}`;document.getElementById('tables').innerHTML='<table><tr><th>Angle</th><th>N</th><th>Mean RT</th><th>SD</th></tr>'+rows.map(r=>`<tr><td>${r.angle}</td><td>${r.n}</td><td>${r.mean.toFixed(1)}</td><td>${r.sd.toFixed(1)}</td></tr>`).join('')+'</table>';}
window.addEventListener('keydown',e=>{if(e.key==='s'||e.key==='S')respond('same');if(e.key==='d'||e.key==='D')respond('diff')});
document.getElementById('btn-same').onclick=()=>respond('same');document.getElementById('btn-diff').onclick=()=>respond('diff');document.getElementById('btn-start').onclick=()=>{state.total=parseInt(document.getElementById('ntrials').value)||80;state.trial=0;state.data=[];newTrial()};document.getElementById('btn-shape').onclick=()=>{BASE=genPolyomino(10);MIRROR=mirrorX(BASE);clear();draw3D(ctxL,BASE,{angle:0,...center(canvasL)});draw3D(ctxR,BASE,{angle:0,...center(canvasR)});};
</script>
</body>
</html>